name: Auto-assign by labels (satellite)

on:
  issues:
    types: [opened, labeled, unlabeled, edited]
  pull_request:
    types: [opened, labeled, unlabeled, edited]

permissions:
  contents: read
  issues: write
  pull-requests: write
 

jobs:
  assign:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Auto-assign based on main hub mapping
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          script: |
            const org = context.repo.owner;
            const repo = context.repo.repo;
            const item = context.payload.issue || context.payload.pull_request;

            if (!item) {
              console.log("âŒ ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½ issue Ð¸Ð»Ð¸ PR");
              return;
            }

            const number = item.number;
            const labels = item.labels.map(l => l.name);
            console.log("ðŸ·ï¸ Ð›ÐµÐ¹Ð±Ð»Ñ‹:", labels.join(", "));

            // ðŸ”¹ Ð¡Ð¾Ð¿Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ label â†’ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°, ÐºÐ°Ðº Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¼ Ñ…Ð°Ð±Ðµ
            const labelToTeam = {
              "area/design-system": "design-team",
              "area/components": "frontend-specialists",
              "area/accessibility": "a11y-experts",
              "area/performance": "performance-team",
              "area/tooling": "devops-team",
              "area/i18n": "i18n-team",
              "area/mobile": "mobile-team"
            };

            // Ð¢ÐµÐºÑƒÑ‰Ð¸Ðµ assignees
            const currentAssignees = item.assignees?.map(a => a.login) || [];
            const desiredAssignees = new Set();

            for (const label of labels) {
              const team = labelToTeam[label];
              if (!team) continue;

              try {
                const members = await github.rest.teams.listMembersInOrg({
                  org: 'cdek-it', // Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ Ñ…Ð°Ð±Ð°
                  team_slug: team
                });
                members.data.forEach(m => desiredAssignees.add(m.login));
              } catch (error) {
                console.log(`âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ ${team}: ${error.message}`);
              }
            }

            const toAdd = Array.from(desiredAssignees).filter(a => !currentAssignees.includes(a));
            const toRemove = currentAssignees.filter(a => !desiredAssignees.has(a));

            if (toAdd.length > 0) {
              await github.rest.issues.addAssignees({
                owner: org,
                repo,
                issue_number: number,
                assignees: toAdd
              });
              console.log("âœ… Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð½Ð¾Ð²Ñ‹Ðµ assignees");
            }

            if (toRemove.length > 0) {
              await github.rest.issues.removeAssignees({
                owner: org,
                repo,
                issue_number: number,
                assignees: toRemove
              });
              console.log("âœ… Ð£Ð´Ð°Ð»ÐµÐ½Ñ‹ Ð»Ð¸ÑˆÐ½Ð¸Ðµ assignees");
            }
